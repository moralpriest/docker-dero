# Stage 1: Build the application
ARG GO_VERSION=1.23
FROM golang:${GO_VERSION}-alpine AS builder

# Install necessary build tools and strip binaries
RUN apk add --no-cache binutils upx

# Build arguments
ARG P2P_PORT=18089
ARG RPC_PORT=9999
ARG GETWORK_PORT=10100
ARG VERSION=1.0.0

# Add proper labels
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.description="Dero daemon node"
LABEL org.opencontainers.image.source="https://github.com/civilware/derohe"

# Set maintainer
LABEL maintainer="moralpriest@tutamail.com"

WORKDIR /app

# Copy go.mod and go.sum to leverage Docker cache
COPY go.mod go.sum ./

# Download dependencies and clean cache
RUN go mod download && \
    go mod tidy && \
    rm -rf /go/pkg/mod/cache

# Copy the rest of the application source code
COPY . .

# Build both binaries with maximum optimization
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=mod \
    -gcflags="-N -l" \
    -trimpath \
    -ldflags="-s -w -buildid=" \
    -o derod ./cmd/derod && \
    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=mod \
    -gcflags="-N -l" \
    -trimpath \
    -ldflags="-s -w -buildid=" \
    -o healthchecker ./cmd/healthchecker && \
    strip --strip-all derod healthchecker && \
    upx --best --lzma derod healthchecker && \
    rm -rf /go/pkg /go/src

# Stage 2: Create the final minimal image from scratch
FROM scratch

# Re-declare build arguments for the second stage
ARG P2P_PORT=18089
ARG RPC_PORT=9999
ARG GETWORK_PORT=10100
ARG VERSION=1.0.0

# Set working directory
WORKDIR /app

# Copy only the necessary files and minimal SSL certificates
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
COPY --from=builder /app/derod /usr/local/bin/derod
COPY --from=builder /app/healthchecker /usr/local/bin/healthchecker

# Create /data directory path
VOLUME /data

# Expose ports
EXPOSE ${P2P_PORT}/tcp
EXPOSE ${RPC_PORT}/tcp
EXPOSE ${GETWORK_PORT}/tcp

# Healthcheck with more conservative settings
HEALTHCHECK --interval=60s --timeout=10s --start-period=2m --retries=3 CMD ["/usr/local/bin/healthchecker"]

# Default command with arguments
ENTRYPOINT ["/usr/local/bin/derod"]
CMD ["--rpc-bind=0.0.0.0:9999", "--data-dir=/data"]
